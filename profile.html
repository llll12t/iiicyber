<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script> <!-- LIFF SDK -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-gradient-to-r from-slate-900 to-slate-800 flex justify-center items-center max-w-sm mx-auto min-h-screen">
    
    <div class="max-w-sm w-full p-6 rounded-xl text-white ">

        <div class="flex justify-between items-center mb-4">
            <div>
                <p class="text-gray-100 text-xs">Welcome back</p>
                <input type="text" class="input-field bg-slate-900 text-white text-xl font-bold bg-opacity-0 "
                    id="displayName" name="displayName" readonly>
            </div>
            <div class="w-12 h-12 rounded-lg flex justify-center items-center shadow-inner">
                <img src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png"
                    alt="Profile Image" id="profileImage" class="w-10 h-10 bg-white rounded-lg shadow-lg">
            </div>
        </div>
        <div class="flex items-center border border-teal-400 p-1 space-x-2 rounded-md mb-4">
            <input type="text"
                class="input-field bg-gray-50 w-full text-center text-teal-400 text-xs font-bold bg-opacity-0 "
                id="userId" placeholder="Line ID" name="userId" readonly>
        </div>


        <form id="edit-form">

            <input type="hidden" id="edit-id">

            <div class="mb-4 hidden">
                <label for="edit-userID" class="block text-sm">UserID</label>
                <input type="text" id="edit-userID" class="w-full border px-2 py-1 rounded" disabled>
            </div>
            <div class="flex my-8">
                <div class="w-1/3">
                    <label for="edit-imageUrl" class="block hidden text-sm">URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
                    <input type="hidden" id="edit-imageUrl" class="w-full border px-2 py-1 rounded"
                        oninput="updateImagePreview()" disabled>
                    <img id="image-preview"
                        src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png"
                        alt="Image Preview" class="w-20 h-20 rounded">
                </div>
                <div class="bg-teal-400 w-2/3 text-white p-4 rounded flex items-center">
                    <div class="flex justify-between w-full">
                        <div>
                            <p class="text-black text-xs font-bold">POINT</p>
                            <p class="text-sm font-bold">RANK A</p>
                        </div>
                        <div>
                            <input type="text"
                                class="input-field w-16 bg-slate-900 text-white text-3xl text-teal-900 text-right font-bold bg-opacity-0 "
                                id="edit-point" name="edit-point" readonly>
                        </div>
                    </div>
                </div>

            </div>
            <div class="mb-4 hidden" id="image-upload-section">
                <label for="edit-image" class="block text-sm">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
                <input type="file" id="edit-image" class="w-full border px-2 py-1 rounded" disabled>
            </div>
            <div class="mb-4">
                <label for="edit-name" class="block text-xs text-teal-400">‡∏ä‡∏∑‡πà‡∏≠ ‡∏™‡∏Å‡∏∏‡∏•</label>
                <input type="text" id="edit-name" class="input-field bg-slate-900 text-white text-md font-bold bg-opacity-0 " disabled>
            </div>
            <div class="mb-4">
                <label for="edit-employeeID" class="block text-xs text-teal-400">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                <input type="text" id="edit-employeeID" class="input-field bg-slate-900 text-white text-md font-bold bg-opacity-0 " disabled>
            </div>
            <div class="mb-4">
                <label for="edit-department" class="block text-xs text-teal-400">Birthday üéÅ üéÇ</label>
                <input type="text" id="edit-department" class="input-field bg-slate-900 text-white text-md font-bold bg-opacity-0 " disabled>
            </div>
            <div class="flex justify-start">
                <button type="button" id="edit-button"
                    class="bg-yellow-500 text-white py-1 px-3 rounded hover:bg-yellow-700">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button type="button" class="bg-red-500 text-white py-1 px-3 rounded hover:bg-red-700 mr-2 hidden"
                    onclick="cancelEdit()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="submit"
                    class="bg-blue-500 text-white py-1 px-3 rounded hover:bg-blue-700 hidden">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </form>
    </div>


    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby0eHPtQ5rRIkj28JjR3ukh9m9gwyTUHQi4DyLRl9EIMRVusiHb7yp77KXuFFqBumfz-A/exec';
        const LIFF_ID = '2005629952-Zeqeklp9'; // Liff ID

        let latestData = {};

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏õ‡∏∏‡πà‡∏°
        function toggleFormEditing(enable) {
            const inputs = document.querySelectorAll('#edit-form input');
            const saveButton = document.querySelector('#edit-form button[type="submit"]');
            const cancelButton = document.querySelector('#edit-form button[type="button"]:not(#edit-button)');
            const imageUploadSection = document.getElementById('image-upload-section');

            inputs.forEach(input => {
                input.disabled = !enable; // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å input
            });

            if (enable) {
                saveButton.classList.remove('hidden');
                cancelButton.classList.remove('hidden');
                imageUploadSection.classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                document.getElementById('edit-button').classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° Edit ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            } else {
                saveButton.classList.add('hidden');
                cancelButton.classList.add('hidden');
                imageUploadSection.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                document.getElementById('edit-button').classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Edit
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡∏≤‡∏° URL ‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô
        function updateImagePreview() {
            const imageUrl = document.getElementById('edit-imageUrl').value;
            const imagePreview = document.getElementById('image-preview');
            imagePreview.src = imageUrl ? imageUrl : ''; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï src ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        }

        async function searchDataByUserlineId(userlineId) {
    try {
        const response = await fetch(WEB_APP_URL);
        const data = await response.json();

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö userlineId
        const filteredData = data.filter(row => row[1] === userlineId);

        if (filteredData.length > 0) {
            // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏û‡∏ö
            latestData = filteredData[filteredData.length - 1]; 

            // ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
            document.getElementById('edit-id').value = latestData[0];
            document.getElementById('edit-userID').value = latestData[1];
            document.getElementById('edit-name').value = latestData[2];
            document.getElementById('edit-employeeID').value = latestData[3];
            document.getElementById('edit-department').value = latestData[4];
            document.getElementById('edit-imageUrl').value = latestData[5];
            document.getElementById('edit-point').value = latestData[6];

            updateImagePreview(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        } else {
            Swal.fire({
                title: 'Not Found',
                text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö UserLineID ‡∏ô‡∏µ‡πâ',
                icon: 'warning',
                confirmButtonText: 'OK'
            });
        }
    } catch (error) {
        console.error('Error fetching data:', error);
        Swal.fire({
            title: 'Error',
            text: 'Failed to fetch data. Please try again.',
            icon: 'error',
            confirmButtonText: 'OK'
        });
    }
}

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°
        window.onload = async () => {
            await initializeLiff(),getUserProfile(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF ‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ userId
            toggleFormEditing(false); // ‡∏•‡πá‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°
        };

        async function initializeLiff() {
            try {
                await liff.init({ liffId: `${LIFF_ID}` }); // ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    const userlineId = profile.userId; // ‡∏î‡∏∂‡∏á userId ‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
                    searchDataByUserlineId(userlineId); // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° userId
                } else {
                    liff.login();
                }
            } catch (error) {
                console.error('LIFF Initialization failed', error);
            }
        }
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å LIFF
        async function getUserProfile() {
            try {
                // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                const profile = await liff.getProfile();
                const userId = profile.userId;
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ userId ‡πÅ‡∏•‡∏∞ displayName ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
                document.getElementById('userId').value = userId;
                document.getElementById('displayName').value = profile.displayName;
                document.getElementById('profileImage').src = profile.pictureUrl || DEFAULT_IMAGE_URL;

            } catch (error) {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏ã‡∏•
                console.error('Error getting profile data:', error);
            }
        }
        document.getElementById('edit-button').addEventListener('click', function () {
            toggleFormEditing(true); // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        });

        document.getElementById('edit-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const id = document.getElementById('edit-id').value;
            const userID = document.getElementById('edit-userID').value;
            const name = document.getElementById('edit-name').value;
            const employeeID = document.getElementById('edit-employeeID').value;
            const department = document.getElementById('edit-department').value;
            const imageFile = document.getElementById('edit-image').files[0];

            let imageUrl = document.getElementById('edit-imageUrl').value;

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î
            Swal.fire({
                title: 'Saving data...',
                text: 'Please wait while we save your data.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading(); // ‡πÅ‡∏™‡∏î‡∏á spinner
                }
            });

            try {
                let result;
                if (imageFile) {
                    const base64Image = await getBase64(imageFile); // ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Base64
                    result = await updateData(id, userID, name, employeeID, department, base64Image);
                } else {
                    result = await updateData(id, userID, name, employeeID, department, imageUrl);
                }

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
                if (result && result.includes('Data updated')) {
                    Swal.fire({
                        title: 'Success',
                        text: 'Data saved successfully!',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                    await initializeLiff(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                } else {
                    throw new Error(result || 'Failed to save data');
                }

            } catch (error) {
                console.error('Error saving data:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Failed to save data. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            } finally {
                cancelEdit();
            }
        });


        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
        function cancelEdit() {
            document.getElementById('edit-form').reset();
            document.getElementById('edit-id').value = latestData[0];
            document.getElementById('edit-userID').value = latestData[1];
            document.getElementById('edit-name').value = latestData[2];
            document.getElementById('edit-employeeID').value = latestData[3];
            document.getElementById('edit-department').value = latestData[4];
            document.getElementById('edit-imageUrl').value = latestData[5];

            updateImagePreview(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            toggleFormEditing(false); // ‡∏•‡πá‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
        }

        async function updateData(id, userID, name, employeeID, department, base64Image) {
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `method=updateData&id=${id}&userID=${encodeURIComponent(userID)}&name=${encodeURIComponent(name)}&employeeID=${encodeURIComponent(employeeID)}&department=${encodeURIComponent(department)}&imageUrl=${encodeURIComponent(base64Image)}`
            });
            const result = await response.text();

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (!result || result.trim() === '') {
                throw new Error('Empty response from server');
            }

            return result;
        }


        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Base64
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                let reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }



    </script>
</body>

</html>
